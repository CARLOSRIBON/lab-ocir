name: Build and push image to OCIR

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

# ⬇️ AGREGAR ESTOS PERMISOS
permissions:
    contents: read
    security-events: write
    actions: read

env:
    REGISTRY: ${{ vars.OCI_REGION_KEY }}.ocir.io
    IMAGE_NAME: ${{ vars.OCI_TENANCY_NAMESPACE }}/test-cenam
    COMPARTMENT_ID: ocid1.compartment.oc1..aaaaaaaatnlpcqix7l7bxohuqbfrjwgxb3mrw2rjfk6746jcxo4ika7ft2ea

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install OCI CLI
              run: |
                  curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh -o install.sh
                  bash install.sh --accept-all-defaults
                  echo "$HOME/bin" >> $GITHUB_PATH

            - name: Configure OCI CLI
              run: |
                  mkdir -p $HOME/.oci
                  echo ${{ secrets.OCI_CLI_KEY_CONTENT }} | base64 -d > $HOME/.oci/oci_api_key.pem
                  chmod 600 $HOME/.oci/oci_api_key.pem
                  cat <<EOF > $HOME/.oci/config
                  [DEFAULT]
                  tenancy = ${{ vars.OCI_CLI_TENANCY }}
                  user = ${{ vars.OCI_CLI_USER }}
                  fingerprint = ${{ vars.OCI_CLI_FINGERPRINT }}
                  key_file = $HOME/.oci/oci_api_key.pem
                  region = ${{ vars.OCI_CLI_REGION }}
                  EOF
                  oci setup repair-file-permissions --file $HOME/.oci/config

            - name: Create OCIR repo if not exists
              run: |
                  oci artifacts container repository create \
                    --compartment-id ${{ env.COMPARTMENT_ID }} \
                    --display-name test-cenam \
                    --is-public false || true

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Generate tag
              id: tag
              run: echo "tag=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT

            - name: Build Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  load: true
                  tags: |
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
                  format: "sarif"
                  output: "trivy-results.sarif"
                  severity: "CRITICAL,HIGH"
                  exit-code: "1"

            - name: Upload Trivy results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v4
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

            - name: Login to OCIR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: "${{ vars.OCI_TENANCY_NAMESPACE }}/${{ vars.OCI_IDENTITY_DOMAIN }}/${{ vars.OCI_USERNAME }}"
                  password: ${{ secrets.OCI_AUTH_TOKEN }}

            - name: Push Docker image
              run: |
                  docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
                  docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

            - name: Clean up
              if: always()
              run: |
                  rm -f $HOME/.oci/oci_api_key.pem
                  rm -f $HOME/.oci/config
